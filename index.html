<!DOCTYPE html>
<html lang="zh-HK">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>命名練習：水果</title>
    <style>
        body{
            font-family:Arial,sans-serif;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:space-between;
            min-height:100vh;
            margin:0;
            background:#f4f4f9;
        }
        .container{
            width:90%;
            max-width:800px;
            text-align:center;
            padding:20px;
            display:flex;
            flex-direction:column;
            align-items:center;
            flex-grow:1;
        }
        h1{color:#333;margin-bottom:20px}
        #item-image{
            max-width:90%;
            height:auto;
            max-height:58vh;
            border:5px solid #fff;
            box-shadow:0 4px 15px rgba(0,0,0,.1);
            border-radius:12px;
            margin:15px auto;
            display:block;
        }
        #message{
            font-size:2.4em;
            color:#333;
            min-height:90px;
            margin:20px 0;
            font-weight:bold;
        }
        #cue-button{
            background:#007bff;
            color:#fff;
            padding:14px 40px;
            font-size:1.5em;
            border:none;
            border-radius:10px;
            cursor:pointer;
            margin-top:18px;
            margin-bottom:25px;
        }
        #cue-button:hover{background:#0056b3}
        #start-button{
            background:#28a745;
            color:#fff;
            padding:16px 44px;
            font-size:1.7em;
            border:none;
            border-radius:10px;
            cursor:pointer;
        }
        #start-button:hover{background:#1e7e34}
        .progress-bar-container{
            width:100%;
            max-width:800px;
            margin-top:auto;
            padding:10px;
            background:#e9ecef;
            border-top:1px solid #ddd;
        }
        #progress-bar{
            height:38px;
            background:#ffc107;
            border-radius:6px;
            transition:width .5s;
            display:flex;
            align-items:center;
            justify-content:center;
            color:#333;
            font-weight:bold;
            font-size:1.3em;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>命名練習：水果</h1>
       
        <img id="item-image" src="" alt="目標物品圖片" style="display:none">
        <button id="cue-button" style="display:none">提示</button>
        <div id="message"></div>
        <button id="start-button">開始練習</button>
    </div>
    <div class="progress-bar-container"><div id="progress-bar">0/6</div></div>

    <script>
        const questions = [
            {word:"蘋果",image:"蘋果.jpg",semantic_cue:"佢係紅色或者綠色，圓碌碌，好多汁，可以生食。",phonemic_cue:"蘋",foil_word:"橙",correct_aliases:["蘋果"]},
            {word:"香蕉",image:"香蕉.jpg",semantic_cue:"佢係黃色，彎彎哋，好甜，可以剝皮食。",phonemic_cue:"香",foil_word:"芒果",correct_aliases:["香蕉","蕉"]},
            {word:"橙",image:"橙.jpg",semantic_cue:"佢係橙色，要剝皮或者切開，有好多汁，可以搾汁飲。",phonemic_cue:"橙",foil_word:"蘋果",correct_aliases:["橙"]},
            {word:"士多啤梨",image:"士多啤梨.jpg",semantic_cue:"佢係紅色，粒粒凸凸，好甜又有少少酸。",phonemic_cue:"士",foil_word:"藍莓",correct_aliases:["士多啤梨","草莓"]},
            {word:"奇異果",image:"奇異果.jpg",semantic_cue:"佢外面係啡色有毛，切開入面係綠色，有好多細粒黑籽。",phonemic_cue:"奇",foil_word:"西瓜",correct_aliases:["奇異果"]},
            {word:"西瓜",image:"西瓜.jpg",semantic_cue:"佢好大，綠色皮，入面係紅色，有黑籽，夏天食最清熱。",phonemic_cue:"西",foil_word:"菠蘿",correct_aliases:["西瓜"]}
        ];

        let currentQuestionIndex=0, currentCueLevel=0, recognitionActive=false, timer, correctAnswered=false;
        const imageElement=document.getElementById('item-image');
        const messageElement=document.getElementById('message');
        const progressBarElement=document.getElementById('progress-bar');
        const cueButton=document.getElementById('cue-button');
        const startButton=document.getElementById('start-button');
        const synth=window.speechSynthesis;
        let recognition=null;

        // 強制預載語音（對部分 Android 手機很重要）
        speechSynthesis.getVoices();

        function createRecognition(){
            if(recognition) return;
            if(!('SpeechRecognition'in window||'webkitSpeechRecognition'in window)){
                messageElement.textContent="瀏覽器唔支援語音辨識"; startButton.disabled=true; return;
            }
            recognition=new (window.SpeechRecognition||window.webkitSpeechRecognition)();
            recognition.lang='zh-HK';
            recognition.interimResults=false;
            recognition.onresult=e=>{clearTimeout(timer);recognitionActive=false;checkAnswer(e.results[0][0].transcript.trim());};
            recognition.onerror=()=>{recognitionActive=false;if(!correctAnswered&&currentCueLevel<4)startNextCueTimer();};
            recognition.onend=()=>recognitionActive=false;
        }

        // 普通說話
        function speak(text, callback){
            if(!synth){if(callback)callback();return;}
            const utt=new SpeechSynthesisUtterance(text);
            utt.lang='zh-HK';
            utt.rate=0.9;
            if(callback) utt.onend=callback;
            synth.speak(utt);
        }

        // 音韻提示（第一音節慢一點）
        function speakPhonemicCue(callback){
            const ch=questions[currentQuestionIndex].phonemic_cue;
            speak("呢個係……", ()=>{
                const u=new SpeechSynthesisUtterance(ch);
                u.lang='zh-HK';
                u.rate=0.4;
                u.onend=()=>setTimeout(callback||(()=>{}), 1200); // 強制停頓讓第一音節突出
                synth.speak(u);
            });
        }

        // 關鍵：手機也真正一字一字慢慢講（你試下講一次）
        function speakWithSlowWordByWord(prefix, word, finalCallback){
            synth.cancel();
            let i=0;
            const chars=word.split('');

            const prefixUtt=new SpeechSynthesisUtterance(prefix);
            prefixUtt.lang='zh-HK';
            prefixUtt.rate=0.9;
            prefixUtt.onend=speakNextChar;
            synth.speak(prefixUtt);

            function speakNextChar(){
                if(i>=chars.length){
                    const dot=new SpeechSynthesisUtterance("。");
                    dot.lang='zh-HK';
                    dot.rate=0.9;
                    dot.onend=()=>setTimeout(finalCallback||(()=>{}), 600);
                    synth.speak(dot);
                    return;
                }
                const utt=new SpeechSynthesisUtterance(chars[i]);
                utt.lang='zh-HK';
                utt.rate=1; // 不要靠 rate，靠間隔控制
                utt.onend=()=>{
                    i++;
                    setTimeout(speakNextChar, 900 + Math.random()*200); // 每個字之間停 0.9~1.1 秒
                };
                synth.speak(utt);
            }
        }

        function updateProgress(){
            const p=(currentQuestionIndex/questions.length)*100;
            progressBarElement.style.width=p+'%';
            progressBarElement.textContent=`${currentQuestionIndex}/${questions.length}`;
            if(currentQuestionIndex===questions.length){
                progressBarElement.style.backgroundColor='#28a745';
                progressBarElement.textContent="完成！";
            }
        }

        function startListening(){
            if(!recognition||recognitionActive||correctAnswered) return;
            recognition.start(); 
            recognitionActive=true; 
            startNextCueTimer();
        }

        function startNextCueTimer(){
            clearTimeout(timer);
            timer=setTimeout(()=>{
                if(correctAnswered) return;
                recognitionActive=false;
                setTimeout(moveToNextCue,1000);
            },10000);
        }

        function checkAnswer(ans){
            const q=questions[currentQuestionIndex];
            const correct=q.correct_aliases.some(a=>ans.includes(a));
            if(correct){
                correctAnswered=true; clearTimeout(timer); recognition?.stop(); synth.cancel();
                cueButton.style.display='none';
                handleCorrectAnswer(q.word);
            }else{
                setTimeout(moveToNextCue,1500);
            }
        }

        function handleCorrectAnswer(w){
            currentCueLevel=0; correctAnswered=false;
            messageElement.textContent=w;
            const fb=["啱喇","冇錯","做得好"][Math.floor(Math.random()*3)]+`！呢個就係${w}。`;
            speak(fb,()=>setTimeout(moveToNextQuestion,800));
        }

        function moveToNextCue(){
            if(correctAnswered) return;
            currentCueLevel++;
            const q=questions[currentQuestionIndex];
            messageElement.textContent="";
            cueButton.style.display='block';

            if(currentCueLevel===1){
                speak(`你再諗諗。提示：${q.semantic_cue}`, startListening);
            }
            else if(currentCueLevel===2){
                speakPhonemicCue(startListening);
            }
            else if(currentCueLevel===3){
                const opts=[q.word, q.foil_word];
                opts.sort(()=>Math.random()-0.5);
                speak(`你估下，呢個係${opts[0]}定${opts[1]}啊？`, startListening);
            }
            else{
                cueButton.style.display='none';
                handleFinalAnswer(q.word);
            }
        }

        function handleFinalAnswer(w){
            clearTimeout(timer); currentCueLevel=0;
            messageElement.textContent=w;
            speakWithSlowWordByWord(`呢個係${w}，你試下講一次，`, w, ()=>setTimeout(moveToNextQuestion,3000));
        }

        function moveToNextQuestion(){
            currentQuestionIndex++; 
            currentCueLevel=0; correctAnswered=false; 
            updateProgress();
            if(currentQuestionIndex<questions.length){
                loadQuestion(currentQuestionIndex);
            }else{
                handleCompletion();
            }
        }

        function loadQuestion(i){
            const q=questions[i];
            imageElement.src=q.image;
            imageElement.alt=q.word;
            imageElement.style.display='block';
            cueButton.style.display='block';
            messageElement.textContent="";
            speak("呢個咩嚟架？", startListening);
        }

        function handleCompletion(){
            imageElement.style.display='none';
            cueButton.style.display='none';
            messageElement.textContent="做得非常好，我哋已經完成呢個練習喇！";
            speak("做得非常好，我哋已經完成呢個練習喇！");
            startButton.style.display='block';
            startButton.textContent='重新開始';
        }

        startButton.onclick=()=>{
            createRecognition();
            startButton.style.display='none';
            currentQuestionIndex=-1;
            updateProgress();
            moveToNextQuestion();
        };

        cueButton.onclick=()=>{
            if(correctAnswered) return;
            clearTimeout(timer); recognition?.stop(); synth.cancel();
            moveToNextCue();
        };

        // 初始化進度條
        updateProgress();
    </script>
</body>
</html>
